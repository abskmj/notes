<!doctype html><html lang=en><head><title>Upload files to MongoDB GridFS with Express :: Notes</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Create express based APIs to upload and download files to and from MongoDB GridFS."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://abskmj.github.io/notes/posts/express/express-multer-mongoose-gridfile/><link rel=stylesheet href=https://abskmj.github.io/notes/styles.css><link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/29548356?s=32&amp;v=4"><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Upload files to MongoDB GridFS with Express"><meta property="og:description" content="Create express based APIs to upload and download files to and from MongoDB GridFS."><meta property="og:url" content="https://abskmj.github.io/notes/posts/express/express-multer-mongoose-gridfile/"><meta property="og:site_name" content="Notes"><meta property="og:image" content="https://avatars.githubusercontent.com/u/29548356?s=32&amp;v=4"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2020-09-21 12:00:02 +0530 +0530"><link rel=apple-touch-icon sizes=180x180 href=/notes/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/notes/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/notes/favicon-16x16.png><link rel=manifest href=/notes/site.webmanifest><meta name=google-site-verification content="f4QUPyqBnCYP57-SME_dv0q-Di8xwBAOMIhlBGeVWJY"><script async src="https://www.googletagmanager.com/gtag/js?id=G-CMVNGMLVMF"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CMVNGMLVMF")</script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "aa73cbf1591c45448ff0b2735f97bb74"}'></script></head><body class=green><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/notes><div class=logo>Notes</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=https://discordapp.com/users/220585271983472650>Discord</a></li><li><a href=mailto:contact.abskmj@gmail.com>Email</a></li><li><a href=https://github.com/abskmj>Github</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=https://discordapp.com/users/220585271983472650>Discord</a></li><li><a href=mailto:contact.abskmj@gmail.com>Email</a></li><li><a href=https://github.com/abskmj>Github</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://abskmj.github.io/notes/posts/express/express-multer-mongoose-gridfile/>Upload files to MongoDB GridFS with Express</a></h1><div class=post-meta><time class=post-date>2020-09-21</time></div><span class=post-tags>#<a href=https://abskmj.github.io/notes/tags/express/>Express</a>&nbsp;
#<a href=https://abskmj.github.io/notes/tags/mongodb/>MongoDB</a>&nbsp;
#<a href=https://abskmj.github.io/notes/tags/gridfs/>GridFS</a>&nbsp;
#<a href=https://abskmj.github.io/notes/tags/multer/>Multer</a>&nbsp;
#<a href=https://abskmj.github.io/notes/tags/javascript/>JavaScript</a>&nbsp;
#<a href=https://abskmj.github.io/notes/tags/nodejs/>NodeJS</a>&nbsp;
#<a href=https://abskmj.github.io/notes/tags/database/>Database</a>&nbsp;
#<a href=https://abskmj.github.io/notes/tags/mongoose/>Mongoose</a>&nbsp;</span><div class=post-content><div><p>Create express based APIs to upload and download files to and from MongoDB GridFS.</p><blockquote><p><a href=https://docs.mongodb.com/manual/reference/glossary/#term-gridfs>GridFS</a> is a specification for storing and retrieving files that exceed the BSON-document size limit of 16 MB.</p></blockquote><h1 id=install-dependencies>Install Dependencies<a href=#install-dependencies class=hanchor arialabel=Anchor>&#8983;</a></h1><ul><li><code>express</code> to create the APIs</li><li><code>multer</code> to handle multi-part file uploads</li><li><code>mongoose</code> to manage connections to MongoDB</li><li><code>gridfile</code> to manage interactions with GridFS</li></ul><h1 id=gridfile-mongoose-model>GridFile Mongoose Model<a href=#gridfile-mongoose-model class=hanchor arialabel=Anchor>&#8983;</a></h1><p><a href=https://github.com/abskmj/gridfile>GridFile</a> is a reusable Mongoose Schema for MongoDB GridFS.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// gridfile.model.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mongoose</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;mongoose&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>schema</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;gridfile&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>mongoose</span>.<span style=color:#a6e22e>model</span>(<span style=color:#e6db74>&#39;GridFile&#39;</span>, <span style=color:#a6e22e>schema</span>)
</span></span></code></pre></div><h1 id=multer-middleware>Multer Middleware<a href=#multer-middleware class=hanchor arialabel=Anchor>&#8983;</a></h1><p><a href=https://www.npmjs.com/package/multer>Multer</a> will parse <code>multipart/form-data</code> request and the uploaded files will be accessible as <code>req.files</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>multer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;multer&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>upload</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>multer</span>({ <span style=color:#a6e22e>dest</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#39;.&#39;</span>) })
</span></span></code></pre></div><h1 id=upload-file-api>Upload File API<a href=#upload-file-api class=hanchor arialabel=Anchor>&#8983;</a></h1><p>API uses the multer middleware and GridFile model to upload files to GridFS.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;/v1/files&#39;</span>, <span style=color:#a6e22e>upload</span>.<span style=color:#a6e22e>any</span>(), <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>nxt</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// uploaded file are accessible as req.files
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>files</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>promises</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>files</span>.<span style=color:#a6e22e>map</span>(<span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>file</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileStream</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>createReadStream</span>(<span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// upload file to gridfs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>gridFile</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>GridFile</span>({ <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>originalname</span> })
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>gridFile</span>.<span style=color:#a6e22e>upload</span>(<span style=color:#a6e22e>fileStream</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// delete the file from local folder
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>unlinkSync</span>(<span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> Promise.<span style=color:#a6e22e>all</span>(<span style=color:#a6e22e>promises</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>sendStatus</span>(<span style=color:#ae81ff>201</span>)
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nxt</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><h1 id=list-files-api>List Files API<a href=#list-files-api class=hanchor arialabel=Anchor>&#8983;</a></h1><p>API returns information about uploaded files.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/v1/files&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>nxt</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>files</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>GridFile</span>.<span style=color:#a6e22e>find</span>({})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>files</span>)
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nxt</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>Sample response</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;aliases&#34;</span>: [],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;_id&#34;</span>: <span style=color:#e6db74>&#34;5f6850023516552ad21d0007&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;length&#34;</span>: <span style=color:#ae81ff>7945</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;chunkSize&#34;</span>: <span style=color:#ae81ff>261120</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;uploadDate&#34;</span>: <span style=color:#e6db74>&#34;2020-09-21T07:02:26.389Z&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;filename&#34;</span>: <span style=color:#e6db74>&#34;attachment.pdf&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;md5&#34;</span>: <span style=color:#e6db74>&#34;fa7d7e650b2cec68f302b31ba28235d8&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><h1 id=download-file-api>Download File API<a href=#download-file-api class=hanchor arialabel=Anchor>&#8983;</a></h1><p>API returns the file from the GridFS using its id.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/v1/files/:id/:name&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>nxt</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>name</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>gridFile</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>GridFile</span>.<span style=color:#a6e22e>findById</span>(<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>gridFile</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>attachment</span>(<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>gridFile</span>.<span style=color:#a6e22e>downloadStream</span>(<span style=color:#a6e22e>res</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// file not found
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>404</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;file not found&#39;</span> })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nxt</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>Sample Request URL</p><pre tabindex=0><code>/v1/files/5f6850023516552ad21d0007/attachment.pdf
</code></pre><blockquote><p>A working codebase for reference is available at <a href=https://gist.github.com/abskmj/655dbc3191e108d6a5a55e28446bc1e9>gist.github.com</a></p></blockquote></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://abskmj.github.io/notes/posts/freelance/payments/><span class=button__icon>←</span>
<span class=button__text>Receive International Payments for freelance work in India</span>
</a></span><span class="button next"><a href=https://abskmj.github.io/notes/posts/tampermonkey/vue/><span class=button__text>Use Vue.js in a TamperMonkey Script</span>
<span class=button__icon>→</span></a></span></div></div><div id=sponsor class=pagination style=display:none><div class=pagination__title><span class=pagination__title-h>Sponsor</span><hr></div><div class=pagination__buttons><a id=sponsor-link href=https://wise.prf.hn/l/rwNWqOE target=_blank><span id=sponsor-text style=white-space:normal>Wise is a cheaper, faster way to send money abroad. Join over 10 million people who get the real exchange rate
with Wise. They’re up to 8x cheaper than banks.</span></a></div></div><script src=//ace-ally.onrender.com/next.js></script><div class=pagination><div class=pagination__title><span class=pagination__title-h>Discuss Post</span><hr></div><div class=pagination__buttons><span class="button next"><a href="https://github.com/abskmj/notes/discussions/new?category=general&label=comment&title=Upload%20files%20to%20MongoDB%20GridFS%20with%20Express"><span class=button__text>Comment</span>
<span class=button__icon>→</span>
</a></span><span class="button next"><a href=https://github.com/abskmj/notes/tree/master/content/posts/express/express-multer-mongoose-gridfile.md><span class=button__text>Edit at Github</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>&copy; abskmj</span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/notes/bundle.min.js></script></div></body></html>